<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Test Ws.Sequence Utility</title>

<style type="text/css">
    #log div {
        background-color: #F5F5DC;
        border-radius: 10px;
        padding: 10px;
        margin: 10px;
    }

    #log h2 {
        font-size: 1.2em;
        margin: 5px 2px;
    }

    #log p {
        color: #696969;
        margin: 2px;
    }

    .error {
        color: #900;
    }

   #anime {
      width: 50px;
      height: 50px;
      padding: 10px;
      top: 0;
      left: 0;
      position: absolute;
      background-color: red;
      color: white;
      font-weight: bold;
      font-size: 40px;
   }
</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="jquery.sequence.js"></script>
<script type="text/javascript">
jQuery(function($) {

   /*********************************
    * Define our tests
    *********************************/

   var Sequence = $.Sequence;

   var testScope = new (function TestScope() { this.msg = 'from scope'; })();

   var tests = [

      ['jQuery.fn.animate() CALL', function(next) {
         var incCount = 0, $e = $('<div id="anime">0</div>').appendTo('body');
         function _inc() { $e.html(++incCount); }

         Sequence.start()
               .register('fadeTo', jQuery.fn.fadeTo, {cbPos: 2, defaults: ['slow', 0]})
               .register('moveTo', jQuery.fn.animate, {cbPos: 1, cbKey: 'complete', defaults: [{}, {duration: 1000}]})
               .run($e, 'fadeTo', 'normal', 1) // show the element
               .then(_inc)
               .run($e, 'moveTo', {top: 250, left: 250})
               .then(_inc)
               .wait(500)
               .run($e, 'moveTo', {top: 5, left: 5})
               .then(_inc)
               .wait(2000)
               .run($e, 'fadeTo')             // uses defaults
               .then(next);
      }],

      ['WAIT() TEST', function(next) {
         Sequence.start()
               .then(function() { log.msg('start'); })
               .wrap(function() { return (new Date()).getTime(); }) // get current time in millis
               .then(function(v) { log.msg('then', 'start time: '+v); }, function(e) { log.error('then.error', e); })
               .wait(500)
               .wrap(function(v) { return 'Waited for '+((new Date()).getTime()-v)+' milliseconds'; }, Sequence.PREV)
               .then(function(v) { log.msg('then', v); }, function(e) { log.error('then.error', e); })
               .end()
               .done(function(v) { log.msg('done', v); })
               .fail(function(v) { log.error('should not have called fail()'); })
               .always(function(v) {
                  log.msg('always', v);
                  next()
               });
      }],

      [ 'WRAP() SUCCESS', function(next) {
         Sequence.start()
               .wrap(function() { return 'hello'; })
               .then(function(v){ log.msg('then(1)', v); })
               .wrap(function() { return 'hello world'; })
               .then(function(v){ log.msg('then(2)', v); })
               .end()
               .done(function(v) { log.msg('done', v); })
               .fail(function(v) { log.msg('fail', v); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      [ 'WRAP() FAIL', function(next) {
         Sequence.start()
               .wrap(function() { throw 'oops'; })
               .then(function(v){ log.error('then(1)[success] should not get invoked', v); }, function(e) { log.msg('then(1)', e); })
               .wrap(function() { return 'should not run'; })
               .then(function(v){ log.msg('then(2)', v); })
               .end()
               .done(function(v) { log.error('done() should not run', v); })
               .fail(function(e) { log.msg('fail', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      [ 'THEN() THROWS AN ERROR', function(next) {
         Sequence.start()
               .wrap(function() { return 'hello'; })
               .then(function() { throw new Error('then throws an error (expected)'); })
               .wrap(function() { return 'runs after then'; })
               .end()
               .done(function(v) { log.msg('done', v); })
               .fail(function(e) { log.error('fail() should not run', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      [ "HANDLE() SUCCESS", function(next) {
         Sequence.start()
            // a vanilla handle
               .handle(function(cb, msg) {
                  setTimeout(function() { cb(msg); }, 20);
               }, 'hello')
               .then(function(v){ log.msg('then(1)', v); })

            // with the Sequence.CB placeholder
               .handle(function(msg, cb) {
                  setTimeout(function() { cb(msg); }, 1);
               }, 'goodbye', Sequence.CB )
               .then(function(v){ log.msg('then(2)', v); })

            // with the opts directives
               .handle({cbPos: 1}, function(a, cb) {
                  setTimeout(function() { cb(a); }, 1);
               }, 'with opts')
               .then(function(v){ log.msg('then(3)', v); })

            // put callback into existing key
               .handle({cbPos: 0, cbKey: 'fx'}, function(opts) {
                  setTimeout(function() { opts.fx(opts.msg); }, 5);
               }, {msg: 'nested callback'})
               .then(function(v){ log.msg('then(4)', v); })

            // with a scope
               .handle(testScope, function(cb) {
                  var self = this;
                  setTimeout(function() { cb(self.msg); }, 10);
               })
               .then(function(v){ log.msg('then(5)', v); })

               .end()
               .done(function(v) { log.msg('done', v); })
               .fail(function(e) { log.error('fail() should not run', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      ["HANDLE() FAIL", function(next) {
         Sequence.start()
            // success
               .handle(function(cb, msg) {
                  setTimeout(function() { cb(msg); }, 500);
               }, 'hello')
               .then(function(v){ log.msg('then(1)', v); })

            // fail
               .handle(function(msg, cb) {
                  setTimeout(function() { cb(new Error('I failed')); }, 1);
               }, 'goodbye', Sequence.CB )
               .then(function(v) { log.error('then(2)[success] should not get invoked'); },
               function(v) { log.msg('then(2)', v); })

            // never run
               .handle(function(cb) {
                  throw new Error('this should not get run!');
               })

               .end()
               .done(function(v) { log.error('done() should not run', v); })
               .fail(function(e) { log.msg('fail', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      ["RUN/REGISTER() SUCCESS", function(next) {
         function TestScope() {
            this.multiply = function(callback, a, b) {
               setTimeout( function() { callback( a * b ); }, 100 );
            }
         }
         var testScope = new TestScope();
         Sequence.start()
               .register( 'add', function(a, b) { return a + b; }, { defaults: [ 0, 1 ], prevPos: 0 } )
               .register( 'sum',
               function(callback, a, b) { return this.multiply(callback, a, b); },
               { cbPos: 0, prevPos: 2 } )
               .run('add')               // 1  ( default=0, default=1 )
               .run('add', 3)            // 4  ( returnValue=1, arg=3 )
               .run('add')               // 5  ( returnValue=4, default=1 )
               .run(testScope, 'sum', 5) // 25 ( returnValue=5, arg=5 )
               .end()
               .done(function(v) { log.msg('done', v); })
               .fail(function(e) { log.error('fail() should not run', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      ["RUN/REGISTER() FAIL (thrown)", function(next) {
         Sequence.start()
               .register( 'throw', function() { throw 'thrown error'; } )
               .run( 'throw' )
               .wrap( function() { throw new Error('this should not run'); })
               .end()
               .done(function(v) { log.error('done() should not run', v); })
               .fail(function(e) { log.msg('fail', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      ["RUN/REGISTER() FAIL (rejected promise)", function(next) {
         Sequence.start()
               .register( 'reject', function() {
                  var def = $.Deferred();
                  setTimeout(function() { def.reject('rejected promise'); }, 10);
                  return def.promise();
               })
               .run( 'reject' )
               .wrap( function() { log.error('this should not run'); })
               .end()
               .done(function(v) { log.error('done() should not run', v); })
               .fail(function(e) { log.msg('fail', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }],

      ["RUN/REGISTER() FAIL (err callback)", function(next) {
         Sequence.start()
               .register( 'errback', function(callback, errback) {
                  errback(new Error('errback'));
               }, {cbPos: 0, errPos: 1})
               .run( 'errback' )
               .wrap( function() { throw new Error('this should not run'); })
               .end()
               .done(function(v) { log.error('done() should not run', v); })
               .fail(function(e) { log.msg('fail', e); })
               .always(function(v) {
                  log.msg('always', v);
                  next();
               });
      }]

   ];

   function runTest(i) {
      var test = tests[i];
      log.group(test[0]);

      test[1](function() {
         if( i < tests.length-1 ) {
            // prevent excessive nesting of scope chains, not that it matters in this case, but keep those
            // design patterns sharp anyway
            log.groupEnd();
            setTimeout(function() {runTest(i+1);}, 1);
         }
      });
   }


   /*********************************
     * Make sure console exists. If not,
     * then create some dummy functions
     * so we don't have to if/else everything
     *********************************/
    var console = window.console||{
        log: function() {},
        warn: function() {},
        error: function() {}
    };

    // IE 9 won't allow us to call console.log.apply (WTF IE!) It also reports typeof(console.log) as 'object' (UNH!)
    // this little mojo will fix that up for our tests
    if (Function.prototype.bind && console && typeof console.log == "object") {
       [
         "log","info","warn","error","assert","dir","clear","profile","profileEnd"
       ].forEach(function (method) {
               console[method] = this.call(console[method], console);
            }, Function.prototype.bind);
    }

    /**
     * Not all consoles support grouping, so adapt those if necessary
     */
    (typeof(console.group) === 'function') || (console.group = function(msg) {
        console.log("\n------------\n"+msg+"\n------------\n");
    });
    (typeof(console.groupEnd) === 'function') || (console.groupEnd = function() {
        //console.log("\n\n");
    });

    var $div;
    var log = {
        group: function(title) {
            console.group(title);
            $div = $('<div><h2>'+title+'</h2></div>').appendTo('#log');
        },

        groupEnd: function() {
            console.groupEnd();
            $div.append('<p>DONE</p>');
        },

        msg: function() {
            console.log.apply(console, $.makeArray(arguments));
            $div.append('<p>'+(arguments.length > 1? arguments[0]+': '+_val(arguments[1]) : _val(arguments[0]))+'</p>');
        },

        error: function() {
            console.error.apply(console, arguments);
            $div.append('<p class="error">'+(arguments.length > 1? arguments[0]+': '+_val(arguments[1]) : _val(arguments[0]))+'</p>');
        }
    };

    function _val(v) {
        if($.isArray(v)) {
            var i, len = v.length, s = '[ ';
            for (i = 0; i < len; i++) {
                if( i > 0 ) { s += ', '; }
                s += _val(v[i]);
            }
            return s+' ]';
        }
        switch(typeof(v)) {
            case 'string':
                return "'"+v+"'";
            case 'boolean':
                return v? '-true-' : '-false-';
            case 'object':
                return v === null? '-null-' : v;
            case 'undefined':
                return '-undefined-';
            default:
                return v;
        }
    }


   /********************************
    * Make with the go!
    *******************************/

    runTest(0);


});
</script>

</head>
<body>

<em>For best output data, open the debug console (F12)</em>

<div id='log'></div>

</body>
</html>